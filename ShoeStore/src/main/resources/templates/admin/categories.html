<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security6">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Quản lý Danh mục</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body{background-color:#f8f9fa}
        .sidebar{position:fixed;top:0;bottom:0;left:0;z-index:100;padding:56px 0 0;box-shadow:inset -1px 0 0 rgba(0,0,0,.1);background-color:#212529}
        .sidebar-sticky{position:relative;top:0;height:calc(100vh - 56px);padding-top:.5rem;overflow-x:hidden;overflow-y:auto}
        .sidebar .nav-link{font-weight:500;color:#adb5bd;padding:.75rem 1.5rem;border-left:3px solid transparent}
        .sidebar .nav-link:hover,.sidebar .nav-link.active{color:#fff;background-color:#495057;border-left-color:#0d6efd}
        .sidebar .nav-link .bi{margin-right:.75rem;font-size:1.1rem;vertical-align:text-bottom}
        .main-content{margin-left:250px;padding:20px;margin-top:56px}
        .navbar-brand{padding:.75rem 1.5rem;font-size:1.2rem;background-color:rgba(0,0,0,.25);box-shadow:inset -1px 0 0 rgba(0,0,0,.25)}
    </style>
</head>

<body>
<header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
    <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" th:href="@{/admin/dashboard}">
        <i class="bi bi-bag-check-fill me-2"></i>SHOE STORE
    </a>
</header>

<div class="container-fluid">
    <div class="row">
        <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
            <div class="sidebar-sticky">
                <ul class="nav flex-column">
                    <!-- Những mục cả manager và staff đều thấy -->
                    <li class="nav-item" sec:authorize="hasAnyAuthority('manager','staff')">
                        <a class="nav-link" th:href="@{/admin/dashboard}">
                            <i class="bi bi-speedometer2"></i>Báo cáo
                        </a>
                    </li>
                    <li class="nav-item" sec:authorize="hasAnyAuthority('manager','staff')">
                        <a class="nav-link" th:href="@{/admin/products}">
                            <i class="bi bi-box-seam"></i>Sản phẩm
                        </a>
                    </li>
                    <li class="nav-item" sec:authorize="hasAnyAuthority('manager','staff')">
                        <a class="nav-link" th:href="@{/admin/orders}">
                            <i class="bi bi-receipt"></i>Đơn hàng
                        </a>
                    </li>
                    <li class="nav-item" sec:authorize="hasAnyAuthority('manager','staff')">
                        <a class="nav-link active" th:href="@{/admin/categories}">
                            <i class="bi bi-tags"></i>Danh mục
                        </a>
                    </li>

                    <!-- Chỉ manager được xem và quản lý Người dùng -->
                    <li class="nav-item" sec:authorize="hasAuthority('manager')">
                        <a class="nav-link" th:href="@{/admin/users}">
                            <i class="bi bi-people"></i>Người dùng
                        </a>
                    </li>

                    <!-- Coupon hiển thị cho manager và staff -->
                    <li class="nav-item" sec:authorize="hasAnyAuthority('manager','staff')">
                        <a class="nav-link" th:href="@{/admin/coupons}">
                            <i class="bi bi-ticket-detailed"></i>Mã giảm giá
                        </a>
                    </li>
                </ul>

                <div class="position-absolute bottom-0 w-100 p-3">
                    <form th:action="@{/logout}" method="post">
                        <button type="submit" class="btn btn-outline-danger w-100">
                            <i class="bi bi-box-arrow-right me-2"></i>Đăng xuất
                        </button>
                    </form>
                </div>
            </div>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
            <h1 class="mb-4 border-bottom pb-2">Quản lý Danh mục</h1>

            <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                <span th:text="${success}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <span th:text="${error}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <button class="btn btn-primary mb-3" data-bs-toggle="modal"
                    data-bs-target="#categoryModal" onclick="clearModalFields()">
                <i class="bi bi-plus-circle me-2"></i> Thêm Danh mục Mới
            </button>

            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tên Danh mục</th>
                                <th class="text-end">Hành động</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="cat : ${categories}">
                                <td th:text="${cat.categoryId}"></td>
                                <td th:text="${cat.categoryName}"></td>
                                <td class="text-end">
                                    <button class="btn btn-warning btn-sm"
                                            th:data-id="${cat.categoryId}"
                                            th:data-name="${cat.categoryName}"
                                            onclick="editCategory(this)">
                                        <i class="bi bi-pencil-square"></i> Sửa
                                    </button>
                                    <a th:href="@{/admin/categories/delete/{id}(id=${cat.categoryId})}"
                                       class="btn btn-danger btn-sm"
                                       onclick="return confirm('Bạn có chắc chắn muốn xóa?')">
                                        <i class="bi bi-trash"></i> Xóa
                                    </a>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="categoryModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form th:action="@{/admin/categories/save}" method="post" th:object="${category}">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="categoryModalLabel">Thêm Danh mục</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" th:field="*{categoryId}" id="catId">
                                <div class="mb-3">
                                    <label for="catName" class="form-label">Tên Danh mục:</label>
                                    <input type="text" th:field="*{categoryName}" class="form-control" id="catName" required>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                <button type="submit" class="btn btn-primary">Lưu</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function editCategory(button) {
        const id = button.getAttribute('data-id');
        const name = button.getAttribute('data-name');
        document.getElementById('catId').value = id;
        document.getElementById('catName').value = name;
        document.getElementById('categoryModalLabel').innerText = 'Sửa Danh mục ID: ' + id;
        var myModal = new bootstrap.Modal(document.getElementById('categoryModal'));
        myModal.show();
    }

    function clearModalFields() {
        document.getElementById('categoryModalLabel').innerText = 'Thêm Danh mục Mới';
        document.querySelector('#categoryModal form').reset();
        document.getElementById('catId').value = '';
    }
</script>
</body>
</html>
