<div th:replace="fragments/layout :: layout(content = ~{::content}, title='Tất cả Sản phẩm Giày')">
<div th:fragment="content">
    <h2 class="mb-4">Tất cả Sản phẩm Giày</h2>

    <div class="row mb-4">
        <div class="col-md-9 position-relative"> 
            <form th:action="@{/products}" method="get" class="d-flex">
                <input class="form-control me-2" type="search" name="keyword"
                       placeholder="Tìm kiếm theo tên..." aria-label="Search"
                       th:value="${currentKeyword}"
                       id="searchInput" onkeyup="fetchSuggestions()" autocomplete="off">
                <button class="btn btn-outline-success" type="submit">Search</button>
            </form>

            <!-- Hộp gợi ý thả xuống -->
            <div id="suggestions-box" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
        </div>

        <div class="col-md-3">
            <select class="form-select" onchange="window.location.href='/products?categoryId=' + this.value">
                <option value="">Lọc theo Danh mục</option>
                <option th:each="cat : ${categories}" 
                        th:value="${cat.categoryId}" 
                        th:text="${cat.categoryName}">
                </option>
            </select>
        </div>
    </div>

    <!-- Danh sách sản phẩm -->
    <div class="row row-cols-1 row-cols-md-4 g-4 mt-3">
        <div class="col" th:each="product : ${products}">
            <div class="card product-card h-100">
                <img th:src="@{${product.imageUrl}}" class="card-img-top"
                     alt="Product Image" style="height: 200px; object-fit: cover;">
                <div class="card-body">
                    <h5 class="card-title" th:text="${product.name}">Tên Giày</h5>
                    <p class="card-text text-danger fs-5"
                       th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT') + ' VND'}">
                       1,500,000 VND
                    </p>
                    <a th:href="@{'/products/' + ${product.productId}}"
                       class="btn btn-primary btn-sm w-100 mt-2">Xem chi tiết</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Phân trang -->
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${productPage.first ? 'disabled' : ''}">
                <a class="page-link"
                   th:href="@{/products(page=${productPage.number - 1}, size=${productPage.size})}">Trước</a>
            </li>

            <li class="page-item"
                th:each="i : ${#numbers.sequence(0, productPage.totalPages - 1)}"
                th:classappend="${i == productPage.number ? 'active' : ''}">
                <a class="page-link"
                   th:href="@{/products(page=${i}, size=${productPage.size})}"
                   th:text="${i + 1}">1</a>
            </li>

            <li class="page-item" th:classappend="${productPage.last ? 'disabled' : ''}">
                <a class="page-link"
                   th:href="@{/products(page=${productPage.number + 1}, size=${productPage.size})}">Tiếp</a>
            </li>
        </ul>
    </nav>

    <!-- Script gợi ý tìm kiếm (đã cập nhật UI đẹp hơn) -->
    <script>
        const searchInput = document.getElementById('searchInput');
        const suggestionsBox = document.getElementById('suggestions-box');
        let timeout = null;

        function fetchSuggestions() {
            clearTimeout(timeout);
            const query = searchInput.value.trim();

            if (query.length < 2) {
                suggestionsBox.innerHTML = '';
                return;
            }

            timeout = setTimeout(() => {
                fetch(`/api/products/suggestions?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        suggestionsBox.innerHTML = '';
                        if (data && data.length > 0) {
                            data.forEach(name => {
                                const item = document.createElement('a');
                                item.href = '#';
                                item.className = 'list-group-item list-group-item-action';
                                item.textContent = name;
                                item.onclick = function(e) {
                                    e.preventDefault();
                                    searchInput.value = name;
                                    suggestionsBox.innerHTML = '';
                                    searchInput.form.submit();
                                };
                                suggestionsBox.appendChild(item);
                            });
                        }
                    })
                    .catch(error => console.error('Lỗi fetch gợi ý:', error));
            }, 300);
        }

        document.addEventListener('click', function(event) {
            if (!searchInput.contains(event.target)) {
                suggestionsBox.innerHTML = '';
            }
        });
    </script>

</div>
</div>
