<div th:replace="fragments/layout :: layout(content = ~{::content}, title='Lịch sử Đơn hàng')">
<div th:fragment="content">
    <h2 class="mb-4"><i class="fas fa-history me-2"></i> Lịch sử Đơn hàng</h2>

    <!-- Nếu chưa có đơn hàng -->
    <div th:if="${orders.empty}" class="alert alert-info text-center">
        Bạn chưa có đơn hàng nào. <a th:href="@{/products}">Bắt đầu mua sắm</a>!
    </div>

    <!-- Danh sách đơn hàng -->
    <div th:each="order : ${orders}" class="card mb-3 shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <div>
                <strong>Mã Đơn hàng:</strong> #<span th:text="${order.orderId}"></span>
                <span class="ms-4 text-muted">
                    Ngày đặt: <span th:text="${#dates.format(order.createdAt, 'dd-MM-yyyy HH:mm')}"></span>
                </span>
            </div>

            <!-- Hiển thị trạng thái đơn và thanh toán -->
            <div>
                <span class="badge me-2"
                      th:classappend="${order.status == 'pending' ? 'bg-warning text-dark' :
                                       (order.status == 'completed' ? 'bg-success' : 'bg-secondary')}"
                      th:text="'Trạng thái: ' + ${order.status}">
                </span>
                <span class="badge"
                      th:classappend="${order.paymentStatus == 'unpaid' ? 'bg-danger' : 'bg-success'}"
                      th:text="'Thanh toán: ' + ${order.paymentStatus}">
                </span>
            </div>
        </div>

        <div class="card-body">
            <h5 class="text-danger mb-3">
                Tổng tiền:
                <span th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT') + ' VND'}"></span>
            </h5>

            <p><strong>Địa chỉ giao hàng:</strong> 
               <span th:text="${order.shippingAddress ?: 'Chưa có thông tin'}"></span>
            </p>

            <!-- Nút xem chi tiết -->
            <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse"
                    th:attr="data-bs-target='#details-' + ${order.orderId}" aria-expanded="false">
                Xem Chi tiết Sản phẩm
            </button>

            <!-- Nút hủy đơn hàng (chỉ hiển thị nếu trạng thái là pending) -->
            <form th:if="${order.status == 'pending'}" th:action="@{/orders/cancel}" method="post" class="d-inline ms-2">
                <input type="hidden" name="orderId" th:value="${order.orderId}">
                <button type="submit" class="btn btn-sm btn-danger"
                        onclick="return confirm('Bạn có chắc chắn muốn hủy đơn hàng này?')">
                    Hủy Đơn Hàng
                </button>
            </form>

            <!-- Chi tiết sản phẩm -->
            <div class="collapse mt-3" th:id="'details-' + ${order.orderId}">
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between align-items-center"
                        th:each="detail : ${order.orderDetails}">
                        <div class="d-flex align-items-center">
                            <img th:src="${detail.product.imageUrl}" alt="img"
                                 style="width: 50px; height: 50px; object-fit: cover; margin-right: 15px;">
                            <span th:text="${detail.product.name}"></span>
                        </div>
                        <div>
                            <span class="me-3 text-muted">Số lượng: 
                                <strong th:text="${detail.quantity}"></strong>
                            </span>
                            <span class="fw-bold"
                                  th:text="${#numbers.formatDecimal(detail.price * detail.quantity, 0, 'COMMA', 0, 'POINT') + ' VND'}">
                            </span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
</div>
